<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\DB;
use Maatwebsite\Excel\Facades\Excel;
use App\Models\Netsale_Mod;

class MailController extends Controller
{
    public function index()
    {
        $ptsmcb = DB::connection("PTSMCB")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        $ptseib = DB::connection("PTSEIB")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        $ptseit = DB::connection("PTSEIT")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        $ptrjb = DB::connection("PTRJB")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        $ptrpm = DB::connection("PTRPM")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        $ptrwi = DB::connection("PTRWI")->select(
            "SELECT O.ERP, O.BRAND, O.TAHUN TAHUN_OLD, N.TAHUN_NEW, O.JAN_OLD + O.FEB_OLD + O.MAR_OLD + O.APR_OLD + O.MAY_OLD + O.JUN_OLD + O.JUL_OLD + O.AUG_OLD + O.SEP_OLD + O.OCT_OLD + O.NOV_OLD + O.DEC_OLD TOTAL_OLD, N.JAN_NEW + N.FEB_NEW + N.MAR_NEW + N.APR_NEW + N.MAY_NEW + N.JUN_NEW + N.JUL_NEW + N.AUG_NEW + N.SEP_NEW + N.OCT_NEW + N.NOV_NEW + N.DEC_NEW TOTAL_NEW, O.JAN_OLD, N.JAN_NEW, O.FEB_OLD, N.FEB_NEW, O.MAR_OLD, N.MAR_NEW, O.APR_OLD, N.APR_NEW, O.MAY_OLD, N.MAY_NEW, O.JUN_OLD, N.JUN_NEW, O.JUL_OLD, N.JUL_NEW, O.AUG_OLD, N.AUG_NEW, O.SEP_OLD, N.SEP_NEW, O.OCT_OLD, N.OCT_NEW, O.NOV_OLD, N.NOV_NEW, O.DEC_OLD, N.DEC_NEW FROM ( SELECT * FROM ( SELECT H.ERP, H.BRAND, H.TAHUN, H.BULAN, NVL(I.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, BULAN, TAHUN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_CHAR(SYSDATE, 'YYYY') -1 WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_CHAR(SYSDATE, 'YYYY') -2 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) H LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_CHAR(DSI_DATE, 'MM') BULAN, SUM( NVL(DSI_DPP_NET, 0) ) TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -2 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) GROUP BY ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM') ORDER BY BRAND, BULAN ASC ) I ON H.BRAND = I.BRAND AND H.ERP = I.ERP AND H.TAHUN = I.TAHUN AND H.BULAN = I.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_old, '02' as feb_old, '03' as mar_old, '04' as apr_old, '05' as may_old, '06' as jun_old, '07' as jul_old, '08' as aug_old, '09' as sep_old, '10' as oct_old, '11' as nov_old, '12' as dec_old ) ) ) O INNER JOIN ( SELECT * FROM ( SELECT X.ERP, X.BRAND, X.TAHUN TAHUN_NEW, X.BULAN, NVL(Z.TOTAL_DSI_DPP_NET, 0) TOTAL_DSI_DPP_NET FROM ( SELECT ERP, BRAND, TAHUN, BULAN FROM ( SELECT DISTINCT ERP, BRAND FROM V_BRAND_NETSALE ) A, ( SELECT CASE WHEN TO_CHAR(SYSDATE, 'MM') != '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) WHEN TO_CHAR(SYSDATE, 'MM') = '01' THEN TO_NUMBER( TO_CHAR(SYSDATE, 'YYYY') ) -1 END TAHUN, TO_CHAR(LEVEL, 'FM00') as BULAN FROM dual CONNECT BY LEVEL <= 12 ) B ORDER BY BRAND, BULAN ASC ) X LEFT JOIN ( SELECT ERP, BRAND, TO_CHAR(DSI_DATE, 'YYYY') TAHUN, TO_NUMBER( TO_CHAR(DSI_DATE, 'MM') ) BULAN, NVL( SUM(DSI_DPP_NET), 0 ) AS TOTAL_DSI_DPP_NET FROM V_BRAND_NETSALE WHERE ( TO_CHAR(SYSDATE, 'MM') = '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') -1 || '-12-31', 'YYYY-MM-DD' ) ) OR ( TO_CHAR(SYSDATE, 'MM') != '01' AND DSI_DATE >= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || '-01-01', 'YYYY-MM-DD' ) AND DSI_DATE <= TO_DATE( TO_CHAR(SYSDATE, 'YYYY') || TO_CHAR(SYSDATE, 'MM') -1 || TO_CHAR(LAST_DAY(TO_DATE(TO_CHAR(SYSDATE, 'MM') -1, 'MM')),'DD'), 'YYYYMMDD' ) ) GROUP BY ERP, TO_CHAR(DSI_DATE, 'YYYY'), TO_CHAR(DSI_DATE, 'MM'), BRAND ORDER BY BRAND ASC, BULAN DESC ) Z ON X.ERP = Z.ERP AND X.BRAND = Z.BRAND AND X.TAHUN = Z.TAHUN AND X.BULAN = Z.BULAN ) PIVOT ( SUM(TOTAL_DSI_DPP_NET) FOR BULAN IN ( '01' as jan_new, '02' as feb_new, '03' as mar_new, '04' as apr_new, '05' as may_new, '06' as jun_new, '07' as jul_new, '08' as aug_new, '09' as sep_new, '10' as oct_new, '11' as nov_new, '12' as dec_new ) ) ) N ON O.BRAND = N.BRAND AND O.ERP = N.ERP ORDER BY BRAND ASC"
        );
        //HITUNG TOTAL PER SMC, RJB, RPM, RWI BUAT TABLE PALING BAWAH
        
        return view(
             "lokal",
            compact("ptsmcb", "ptseib", "ptseit", "ptrjb", "ptrpm","ptrwi")
        );
    }

    public function download_excel(){
        $data = Netsale_Mod::orderByRaw('erp asc, brand asc')->get();
        $data_brand = Netsale_Mod::select(DB::raw('brand , SUM(total_old) total_old , SUM(total_new) total_new , SUM(jan_old) jan_old , SUM(jan_new) jan_new , SUM(feb_old) feb_old , SUM(feb_new) feb_new , SUM(mar_old) mar_old , SUM(mar_new) mar_new , SUM(apr_old) apr_old , SUM(apr_new) apr_new , SUM(may_old) may_old , SUM(may_new) may_new , SUM(jun_old) jun_old , SUM(jun_new) jun_new , SUM(jul_old) jul_old , SUM(jul_new) jul_new , SUM(aug_old) aug_old , SUM(aug_new) aug_new , SUM(sep_old) sep_old , SUM(sep_new) sep_new , SUM(oct_old) oct_old , SUM(oct_new) oct_new , SUM(nov_old) nov_old , SUM(nov_new) nov_new , SUM(dec_old) dec_old , SUM(dec_new) dec_new'))
                        ->groupBy('brand')
                        ->orderBy('brand','asc')
                        ->get();
        $data_brand_persystem = Netsale_Mod::select(DB::raw("brand, SUM(CASE WHEN erp = 'SMCB' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as smcb ,SUM(CASE WHEN erp = 'SEIB' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as seib ,SUM(CASE WHEN erp = 'SEIT' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as seit ,SUM(CASE WHEN erp = 'RJB' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as rjb ,SUM(CASE WHEN erp = 'RPM' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as rpm ,SUM(CASE WHEN erp = 'RWI' THEN jan_new + feb_new + mar_new + apr_new + may_new + jun_new + jul_new + aug_new + sep_new + oct_new + nov_new + dec_new END) as rwi ,SUM(total_old) as total_old ,SUM(total_new) AS total_new"))
                                ->groupBy('brand')
                                ->orderBy('brand','asc')
                                ->get();
        $data_system = Netsale_Mod::select(DB::raw("erp ,SUM(total_new) total_new ,SUM(jan_new) jan_new ,SUM(feb_new) feb_new ,SUM(mar_new) mar_new ,SUM(apr_new) apr_new ,SUM(may_new) may_new ,SUM(jun_new) jun_new ,SUM(jul_new) jul_new ,SUM(aug_new) aug_new ,SUM(sep_new) sep_new ,SUM(oct_new) oct_new ,SUM(nov_new) nov_new ,SUM(dec_new) dec_new"))
                        ->groupBy('erp')
                        ->orderBy('erp','asc')
                        ->get();
        return view(
            "lokal2",
            compact("data","data_brand","data_brand_persystem","data_system")
        );
    }
}
